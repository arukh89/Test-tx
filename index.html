<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>$Seconds Bitcoin TX Battle Royale</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a4a 0%, #4a1a66 100%);
      color: #fff;
      text-align: center;
      padding: 1rem;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 500px;
      background: rgba(30, 30, 70, 0.8);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.3rem;
      color: #f7931a;
    }
    h2 {
      font-size: 1rem;
      margin-top: 0;
      color: #bbb;
    }
    .objective {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1rem;
      margin: 1rem 0;
    }
    .mempool-tip {
      margin: 1rem 0;
      font-size: 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .players-section {
      margin: 1.5rem 0;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
    }
    .guess-form {
      margin: 1.5rem 0;
      width: 100%;
    }
    input, button {
      font-size: 1rem;
      padding: 0.7rem 1rem;
      border: none;
      border-radius: 8px;
      margin-top: 0.5rem;
    }
    input {
      width: 100%;
      text-align: center;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      margin-bottom: 0.5rem;
    }
    button {
      background: #2ecc71;
      color: #000;
      font-weight: bold;
      width: 100%;
    }
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    #winnerBanner {
      margin: 1rem 0;
      font-size: 1.2rem;
      font-weight: bold;
      color: #76ff40;
    }
    #status {
      margin: 1rem 0;
      font-size: 0.9rem;
      color: #8c8c8c;
    }

    /* Chat Styles */
    .chat-container {
      margin-top: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 1rem;
    }

    .chat-messages {
      max-height: 150px;
      overflow-y: auto;
      margin-bottom: 0.5rem;
    }

    .chat-input {
      display: flex;
    }

    .chat-input input {
      flex: 1;
      margin-right: 0.5rem;
    }

    .chat-input button {
      width: auto;
    }

    /* Sharing Buttons */
    .social-sharing {
      margin-top: 1rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    .social-sharing button {
      padding: 0.5rem 1rem;
      background: #f7931a;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0;
      max-height: 100px;
      overflow: auto;
      text-align: left;
    }
    ul li {
      padding: 0.4rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .player-stats {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }
    .stat-card {
      flex: 1 1 45%;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 1rem;
      margin: 0.3rem;
    }
    .stat-card h4 {
      margin-top: 0;
      font-size: 0.8rem;
      color: #bbb;
    }
    .stat-card p {
      margin: 0.3rem 0 0;
      font-size: 1.1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>$Seconds Bitcoin TX Battle Royale</h1>
      <h2>Real-time blockchain competition with miggles.eth</h2>
    </header>

    <div class="objective">
      <h3>üéØ Objective: Predict the number of transactions in Bitcoin blocks</h3>
      <p>Comment your guess below and the closest answer wins.</p>
    </div>

    <p class="mempool-tip">
      Visit <a href="https://mempool.space" target="_blank" style="color: #f7931a">mempool.space</a> to see current projected transactions to help with your guess.<br>
      Strictly only one guess per player.
    </p>

    <div class="players-section">
      <div>Farcaster Participants <span id="fids">(0 FIDs)</span></div>
      <p>Waiting for Farcaster users to join...</p>
      <p>Waiting for players to join...</p>
    </div>

    <div class="guess-form">
      <input id="guessInp" type="number" placeholder="Your guess" disabled>
      <button id="lockBtn" onclick="lockGuess()" disabled>Join Battle</button>
    </div>

    <div id="winnerBanner"></div>
    <div id="status">Connecting to mempool.space...</div>
    <ul id="playersList"></ul>

    <!-- Chat Feature -->
    <div class="chat-container">
      <h3>Chat</h3>
      <div id="chatMessages" class="chat-messages"></div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <!-- Social Sharing -->
    <div class="social-sharing">
      <button onclick="shareWin()">Share Win</button>
      <button onclick="shareGame()">Share Game</button>
    </div>

    <div class="player-stats">
      <div class="stat-card">
        <h4>Players</h4>
        <p id="playersCount">0</p>
      </div>
      <div class="stat-card">
        <h4>Battles Won</h4>
        <p id="battlesWon">0</p>
      </div>
      <div class="stat-card">
        <h4>Total Battles</h4>
        <p id="totalBattles">0</p>
      </div>
      <div class="stat-card">
        <h4>Win Rate</h4>
        <p id="winRate">0%</p>
      </div>
    </div>
  </div>

<script>
  /* --- CONFIG --- */
  const JACKPOT_INC = 250;
  let JACKPOT = 2500;
  let blockHeight = 0;
  let locked = false;
  let guesses = [];
  let myGuess = null;
  let myFid = null;
  let myName = 'Anon';

  /* --- URL STATE MANAGEMENT --- */
  function readHash() {
    try {
      const p = new URLSearchParams(location.hash.slice(1));
      guesses = JSON.parse(p.get('g') || '[]');
      JACKPOT = Number(p.get('pot') || JACKPOT);
      blockHeight = Number(p.get('h') || 0);
    } catch (e) {}
  }

  function pushHash() {
    const p = new URLSearchParams();
    p.set('g', JSON.stringify(guesses));
    p.set('pot', JACKPOT);
    p.set('h', blockHeight);
    location.hash = p.toString();
  }

  /* --- DOM HELPERS --- */
  function byId(id) {
    return document.getElementById(id);
  }

  function renderPlayers() {
    byId('playersList').innerHTML = guesses.map((g, i) => {
      return `<li>${g.name || `Player ${i + 1}`}: ${g.guess} txs</li>`;
    }).join('');
    byId('playersCount').textContent = guesses.length;
  }

  /* --- GUESS LOGIC --- */
  function lockGuess() {
    if (locked) return alert('Round locked. Wait for new block.');
    if (myGuess) return alert('You already guessed!');
    const val = Number(byId('guessInp').value);
    if (!val || isNaN(val) || val < 0) return alert('Enter a positive number');
    myGuess = val;
    guesses.push({ fid: myFid, name: myName, guess: val });
    pushHash();
    renderPlayers();
    byId('guessInp').disabled = true;
    byId('lockBtn').textContent = 'Locked ‚úÖ';
    byId('lockBtn').disabled = true;
  }

  /* --- WEBSOCKET FOR BLOCK DATA --- */
  const ws = new WebSocket('wss://mempool.space/api/v1/ws');
  ws.onopen = () => {
    byId('status').textContent = 'Connected. Waiting for block‚Ä¶';
  };

  ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);
    if (data.block) {
      finishRound(data.block);
    }
    if (data.txCount) {
      byId('status').textContent = `Mempool est. ~${data.txCount} txs in next block`;
    }
  };

  /* --- ROUND FINISH AND SCORING --- */
  function finishRound(block) {
    if (locked) return;
    locked = true;
    const actual = block.tx_count;
    byId('status').textContent = `Block ${block.height} mined with ${actual} txs. Scoring‚Ä¶`;

    if (guesses.length === 0) {
      byId('winnerBanner').textContent = 'No guesses in this round.';
      setTimeout(resetRound, 8000);
      return;
    }

    const ranked = [...guesses].map((g) => {
      g.diff = Math.abs(g.guess - actual);
      return g;
    }).sort((a, b) => a.diff - b.diff);

    const winner = ranked[0];
    byId('winnerBanner').textContent = `üéâ Winner: ${winner.name} (${winner.guess} txs)`;
    createConfetti(); // Visual feedback

    byId('playersList').innerHTML = ranked.map((g, i) => {
      return `<li>${g.name || `Player ${i + 1}`}: ${g.guess} (${g.diff}) ${i === 0 ? 'üèÜ' : ''}</li>`;
    }).join('');

    JACKPOT += JACKPOT_INC;

    setTimeout(resetRound, 8000);
  }

  function resetRound() {
    guesses = [];
    locked = false;
    myGuess = null;
    byId('guessInp').value = '';
    byId('guessInp').disabled = false;
    byId('lockBtn').textContent = 'Join Battle';
    byId('lockBtn').disabled = false;
    byId('winnerBanner').textContent = '';
    byId('status').textContent = 'New round started. Guess!';
    pushHash();
    renderPlayers();
  }

  /* --- Chat Feature --- */
  function sendMessage() {
    const message = document.getElementById('chatInput').value;
    if (!message) return;

    addChatMessage(myName, message);
    document.getElementById('chatInput').value = '';
  }

  function addChatMessage(name, message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');
    messageElement.textContent = `${name}: ${message}`;
    messageElement.style.margin = '0.5rem 0';
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  /* --- Social Sharing --- */
  function shareWin() {
    if (!myGuess || !guesses.find(g => g.fid === myFid && g.winner)) {
      return alert('You haven\'t won yet!');
    }

    if (navigator.share) {
      navigator.share({
        title: 'TX Battle Royale Win',
        text: `I just won the TX Battle Royale with ${myGuess} txs!`,
        url: window.location.href
      });
    } else {
      copyToClipboard(`I just won the TX Battle Royale with ${myGuess} txs! ${window.location.href}`);
      alert('Win message copied to clipboard!');
    }
  }

  function shareGame() {
    if (navigator.share) {
      navigator.share({
        title: 'Join TX Battle Royale',
        text: 'Join me in this exciting Bitcoin TX Battle Royale!',
        url: window.location.href
      });
    } else {
      copyToClipboard(`Join me in this exciting Bitcoin TX Battle Royale! ${window.location.href}`);
      alert('Game link copied to clipboard!');
    }
  }

  function copyToClipboard(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
  }

  /* --- Visual Feedback --- */
  function createConfetti() {
    const confetti = document.createElement('div');
    confetti.style.position = 'fixed';
    confetti.style.top = '0';
    confetti.style.left = '0';
    confetti.style.width = '100%';
    confetti.style.height = '100%';
    confetti.style.pointerEvents = 'none';
    confetti.style.overflow = 'hidden';
    confetti.style.zIndex = '9999';

    for (let i = 0; i < 50; i++) {
      const particle = document.createElement('div');
      particle.style.position = 'absolute';
      particle.style.width = `${Math.random() * 10 + 5}px`;
      particle.style.height = particle.style.width;
      particle.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
      particle.style.borderRadius = '50%';
      particle.style.top = `${Math.random() * 100}%`;
      particle.style.left = `${Math.random() * 100}%`;
      particle.style.opacity = '0';
      particle.style.transition = 'all 2s ease-out';

      setTimeout(() => {
        particle.style.transform = `translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px)`;
        particle.style.opacity = '1';
      }, 10);

      setTimeout(() => {
        particle.style.transform = `translate(${Math.random() * 300 - 150}px, ${Math.random() * 300 - 150}px)`;
        particle.style.opacity = '0';
        particle.style.transition = 'all 3s ease-out';
      }, 1000);

      confetti.appendChild(particle);
    }

    document.body.appendChild(confetti);

    setTimeout(() => {
      document.body.removeChild(confetti);
    }, 4000);
  }

  /* --- Real-Time Notifications --- */
  function setupNotifications() {
    if ('Notification' in window) {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          new Notification('TX Battle Royale', {
            body: 'New round started! Join now!'
          });
        }
      });
    }
  }

  function notifyNewRound() {
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification('TX Battle Royale', {
        body: 'New round started! Place your guess!'
      });
    }
  }

  function notifyWinner(winner) {
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification('TX Battle Royale', {
        body: `üéâ ${winner.name} won the round with ${winner.guess} txs!`
      });
    }
  }

  /* --- FARCASTER INTEGRATION (IF AVAILABLE) --- */
  if (window.fc && window.fc.user) {
    myFid = window.fc.user.fid;
    myName = window.fc.user.username || 'Anon';
    byId('fids').textContent = `(${myFid} FID)`;
  }

  /* --- INITIAL RENDER --- */
  readHash();
  renderPlayers();
  setupNotifications();
  notifyNewRound();
</script>
</body>
</html>
