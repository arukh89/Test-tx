<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>$Seconds Bitcoin TX Battle Royale</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a4a 0%, #4a1a66 100%);
      color: #fff;
      text-align: center;
      padding: 1rem;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 500px;
      background: rgba(30, 30, 70, 0.8);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.3rem;
      color: #f7931a;
    }
    h2 {
      font-size: 1rem;
      margin-top: 0;
      color: #bbb;
    }
    .objective {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1rem;
      margin: 1rem 0;
    }
    .mempool-tip {
      margin: 1rem 0;
      font-size: 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .players-section {
      margin: 1.5rem 0;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
    }
    .guess-form {
      margin: 1.5rem 0;
      width: 100%;
    }
    input, button {
      font-size: 1rem;
      padding: 0.7rem 1rem;
      border: none;
      border-radius: 8px;
      margin-top: 0.5rem;
    }
    input {
      width: 100%;
      text-align: center;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      margin-bottom: 0.5rem;
    }
    button {
      background: #2ecc71;
      color: #000;
      font-weight: bold;
      width: 100%;
    }
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    #winnerBanner {
      margin: 1rem 0;
      font-size: 1.2rem;
      font-weight: bold;
      color: #76ff40;
    }
    #status {
      margin: 1rem 0;
      font-size: 0.9rem;
      color: #8c8c8c;
    }

    /* Chat Styles */
    .chat-container {
      margin-top: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 1rem;
    }

    .chat-messages {
      max-height: 150px;
      overflow-y: auto;
      margin-bottom: 0.5rem;
    }

    .chat-input {
      display: flex;
    }

    .chat-input input {
      flex: 1;
      margin-right: 0.5rem;
    }

    .chat-input button {
      width: auto;
    }

    /* Block Explorer Styles */
    .block-explorer {
      margin-top: 2rem;
    }
    .block-info {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .block-transactions {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 0.5rem;
    }
    .transaction {
      padding: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .transaction:last-child {
      border-bottom: none;
    }

    /* Social Sharing */
    .social-sharing {
      margin-top: 1rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    .social-sharing button {
      padding: 0.5rem 1rem;
      background: #f7931a;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0;
      max-height: 100px;
      overflow: auto;
      text-align: left;
    }
    ul li {
      padding: 0.4rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .player-stats {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }
    .stat-card {
      flex: 1 1 45%;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 1rem;
      margin: 0.3rem;
    }
    .stat-card h4 {
      margin-top: 0;
      font-size: 0.8rem;
      color: #bbb;
    }
    .stat-card p {
      margin: 0.3rem 0 0;
      font-size: 1.1rem;
      font-weight: bold;
    }
  </style>
  <!-- Add Farcaster SDK via CDN -->
  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
  </script>

  <!-- Embedding Meta Tags -->
  <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://via.placeholder.com/1280x768.png?text=TX+Battle+Royale","button":{"title":"Join Battle","action":{"type":"launch_miniapp","name":"TX Battle Royale","url":"https://testtx.netlify.app/index.html","splashImageUrl":"https://via.placeholder.com/1280x768.png?text=TX+Battle+Royale","splashBackgroundColor":"#1a1a4a"}}'>
  <meta name="fc:frame" content='{"version":"1","imageUrl":"https://via.placeholder.com/1280x768.png?text=TX+Battle+Royale","button":{"title":"Join Battle","action":{"type":"launch_frame","name":"TX Battle Royale","url":"https://testtx.netlify.app/index.html","splashImageUrl":"https://via.placeholder.com/1280x768.png?text=TX+Battle+Royale","splashBackgroundColor":"#1a1a4a"}}'>
</head>
<body>
  <!-- Wallet Connection Button -->
  <button id="connectWalletBtn" style="position: fixed; top: 10px; right: 10px; z-index: 1000; padding: 8px 12px; font-size: 0.9rem; display: none;" onclick="connectWallet()">Connect Wallet</button>

  <div class="container">
    <header>
      <h1>$Seconds Bitcoin TX Battle Royale</h1>
      <h2>Real-time blockchain competition with miggles.eth</h2>
    </header>

    <div class="objective">
      <h3>🎯 Objective: Predict the number of transactions in Bitcoin blocks</h3>
      <p>Comment your guess below and the closest answer wins.</p>
    </div>

    <p class="mempool-tip">
      Visit <a href="https://mempool.space" target="_blank" style="color: #f7931a">mempool.space</a> to see current projected transactions to help with your guess.<br>
      Strictly only one guess per player.
    </p>

    <div class="players-section">
      <div>Farcaster Participants <span id="fids">(0 FIDs)</span></div>
      <p>Waiting for Farcaster users to join...</p>
      <p>Waiting for players to join...</p>
    </div>

    <div class="guess-form">
      <input id="guessInp" type="number" placeholder="Your guess">
      <button id="lockBtn" onclick="lockGuess()">Join Battle</button>
    </div>

    <div id="winnerBanner"></div>
    <div id="status">Connecting to mempool.space...</div>
    <ul id="playersList"></ul>

    <!-- Chat Feature -->
    <div class="chat-container">
      <h3>Chat</h3>
      <div id="chatMessages" class="chat-messages"></div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <!-- Block Explorer -->
    <div class="block-explorer">
      <h3>Block Explorer</h3>
      <div class="block-buttons">
        <button id="fetchPreviousBtn" onclick="fetchPreviousBlock()">Previous Block</button>
        <button id="fetchCurrentBtn" onclick="fetchCurrentBlock()">Current Block</button>
        <button id="fetchNextBtn" onclick="fetchNextBlock()">Next Block</button>
      </div>
      <div id="blockData"></div>
    </div>

    <!-- Social Sharing -->
    <div class="social-sharing">
      <button onclick="shareWin()">Share Win</button>
      <button onclick="shareGame()">Share Game</button>
    </div>

    <div class="player-stats">
      <div class="stat-card">
        <h4>Players</h4>
        <p id="playersCount">0</p>
      </div>
      <div class="stat-card">
        <h4>Battles Won</h4>
        <p id="battlesWon">0</p>
      </div>
      <div class="stat-card">
        <h4>Total Battles</h4>
        <p id="totalBattles">0</p>
      </div>
      <div class="stat-card">
        <h4>Win Rate</h4>
        <p id="winRate">0%</p>
      </div>
    </div>
  </div>

  <script>
    /* --- CONFIG --- */
    const JACKPOT_INC = 250;
    let JACKPOT = 2500;
    let blockHeight = 0;
    let locked = true;
    let guesses = [];
    let myGuess = null;
    let myFid = null;
    let myName = 'Anon';
    let sdk;

    /* --- URL STATE MANAGEMENT --- */
    function readHash() {
      try {
        const p = new URLSearchParams(location.hash.slice(1));
        guesses = JSON.parse(p.get('g') || '[]');
        JACKPOT = Number(p.get('pot') || JACKPOT);
        blockHeight = Number(p.get('h') || 0);
      } catch (e) {}
    }

    function pushHash() {
      const p = new URLSearchParams();
      p.set('g', JSON.stringify(guesses));
      p.set('pot', JACKPOT);
      p.set('h', blockHeight);
      location.hash = p.toString();
    }

    /* --- DOM HELPERS --- */
    function byId(id) {
      return document.getElementById(id);
    }

    function renderPlayers() {
      byId('playersList').innerHTML = guesses.map((g, i) => {
        return `<li>${g.name || `Player ${i + 1}`}: ${g.guess} txs</li>`;
      }).join('');
      byId('playersCount').textContent = guesses.length;
    }

    /* --- GUESS LOGIC --- */
    function lockGuess() {
      if (locked) return alert('Round locked. Wait for new block.');
      if (myGuess) return alert('You already guessed!');
      const val = Number(byId('guessInp').value);
      if (!val || isNaN(val) || val < 0) return alert('Enter a positive number');
      myGuess = val;
      guesses.push({ fid: myFid, name: myName, guess: val });
      pushHash();
      renderPlayers();
      byId('guessInp').disabled = true;
      byId('lockBtn').textContent = 'Locked ✅';
      byId('lockBtn').disabled = true;

      // Show the guess as the next block's transaction prediction in the chat
      addChatMessage(myName, `I predict ${val} transactions for the next BTC block`);
      byId('status').textContent = `Your guess (${val} txs) has been recorded as the next block's transaction prediction.`;
    }

    /* --- WEBSOCKET FOR BLOCK DATA --- */
    const ws = new WebSocket('wss://mempool.space/api/v1/ws');
    ws.onopen = () => {
      byId('status').textContent = 'Connected. Waiting for block…';
    };

    ws.onmessage = (msg) => {
      const data = JSON.parse(msg.data);
      if (data.block) {
        finishRound(data.block);
      }
      if (data.txCount) {
        byId('status').textContent = `Mempool est. ~${data.txCount} txs in next block`;
      }
    };

    /* --- ROUND FINISH AND SCORING --- */
    function finishRound(block) {
      if (locked) return;
      locked = true;
      const actual = block.tx_count;
      byId('status').textContent = `Block ${block.height} mined with ${actual} txs. Scoring…`;

      if (guesses.length === 0) {
        byId('winnerBanner').textContent = 'No guesses in this round.';
        setTimeout(resetRound, 8000);
        return;
      }

      const ranked = [...guesses].map((g) => {
        g.diff = Math.abs(g.guess - actual);
        return g;
      }).sort((a, b) => a.diff - b.diff);

      const winner = ranked[0];
      byId('winnerBanner').textContent = `🎉 Winner: ${winner.name} (${winner.guess} txs)`;
      createConfetti();

      byId('playersList').innerHTML = ranked.map((g, i) => {
        return `<li>${g.name || `Player ${i + 1}`}: ${g.guess} (${g.diff}) ${i === 0 ? '🏆' : ''}</li>`;
      }).join('');

      JACKPOT += JACKPOT_INC;

      setTimeout(resetRound, 8000);
    }

    function resetRound() {
      guesses = [];
      locked = false;
      myGuess = null;
      byId('guessInp').value = '';
      byId('guessInp').disabled = false;
      byId('lockBtn').textContent = 'Join Battle';
      byId('lockBtn').disabled = false;
      byId('winnerBanner').textContent = '';
      byId('status').textContent = 'New round started. Guess!';
      pushHash();
      renderPlayers();
    }

    /* --- Chat Feature --- */
    function sendMessage() {
      const message = document.getElementById('chatInput').value;
      if (!message) return;

      addChatMessage(myName, message);
      document.getElementById('chatInput').value = '';
    }

    function addChatMessage(name, message) {
      const chatMessages = document.getElementById('chatMessages');
      const messageElement = document.createElement('div');
      messageElement.textContent = `${name}: ${message}`;
      messageElement.style.margin = '0.5rem 0';
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    /* --- Social Sharing --- */
    function shareWin() {
      if (!myGuess || !guesses.find(g => g.fid === myFid && g.winner)) {
        return alert('You haven\'t won yet!');
      }

      if (navigator.share) {
        navigator.share({
          title: 'TX Battle Royale Win',
          text: `I just won the TX Battle Royale with ${myGuess} txs!`,
          url: window.location.href
        });
      } else {
        copyToClipboard(`I just won the TX Battle Royale with ${myGuess} txs! ${window.location.href}`);
        alert('Win message copied to clipboard!');
      }
    }

    function shareGame() {
      if (navigator.share) {
        navigator.share({
          title: 'Join TX Battle Royale',
          text: 'Join me in this exciting Bitcoin TX Battle Royale!',
          url: window.location.href
        });
      } else {
        copyToClipboard(`Join me in this exciting Bitcoin TX Battle Royale! ${window.location.href}`);
        alert('Game link copied to clipboard!');
      }
    }

    function copyToClipboard(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
    }

    /* --- Visual Feedback --- */
    function createConfetti() {
      const confetti = document.createElement('div');
      confetti.style.position = 'fixed';
      confetti.style.top = '0';
      confetti.style.left = '0';
      confetti.style.width = '100%';
      confetti.style.height = '100%';
      confetti.style.pointerEvents = 'none';
      confetti.style.overflow = 'hidden';
      confetti.style.zIndex = '9999';

      for (let i = 0; i < 50; i++) {
        const particle = document.createElement('div');
        particle.style.position = 'absolute';
        particle.style.width = `${Math.random() * 10 + 5}px`;
        particle.style.height = particle.style.width;
        particle.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
        particle.style.borderRadius = '50%';
        particle.style.top = `${Math.random() * 100}%`;
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.opacity = '0';
        particle.style.transition = 'all 2s ease-out';

        setTimeout(() => {
          particle.style.transform = `translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px)`;
          particle.style.opacity = '1';
        }, 10);

        setTimeout(() => {
          particle.style.transform = `translate(${Math.random() * 300 - 150}px, ${Math.random() * 300 - 150}px)`;
          particle.style.opacity = '0';
          particle.style.transition = 'all 3s ease-out';
        }, 1000);

        confetti.appendChild(particle);
      }

      document.body.appendChild(confetti);

      setTimeout(() => {
        document.body.removeChild(confetti);
      }, 4000);
    }

    /* --- Block Explorer Code --- */
    async function fetchCurrentBlock() {
      try {
        // Fetch the current block height
        const currentBlockHeightResponse = await fetch('https://mempool.space/api/blocks/tip/height');
        const currentBlockHeight = await currentBlockHeightResponse.text();
        const currentBlockHashResponse = await fetch(`https://mempool.space/api/block-height/${currentBlockHeight}`);
        const currentBlockHash = await currentBlockHashResponse.text();
        const currentBlockTransactionsResponse = await fetch(`https://mempool.space/api/block/${currentBlockHash}`);
        const currentBlockData = await currentBlockTransactionsResponse.json();

        // Prepare HTML for block data
        const blockDataHTML = `
          <div class="block-info">
            <h3>Current Block (Height: ${currentBlockHeight})</h3>
            <p>Total Transactions: ${currentBlockData.tx_count}</p>
          </div>
        `;

        // Update the block data section
        byId('blockData').innerHTML = blockDataHTML;
      } catch (error) {
        console.error('Error fetching current block data:', error);
        byId('blockData').innerHTML = '<p>Failed to load current block data. Please try again later.</p>';
      }
    }

    async function fetchPreviousBlock() {
      try {
        const currentBlockHeightResponse = await fetch('https://mempool.space/api/blocks/tip/height');
        const currentBlockHeight = await currentBlockHeightResponse.text();
        const previousBlockHeight = parseInt(currentBlockHeight) - 1;
        const previousBlockHashResponse = await fetch(`https://mempool.space/api/block-height/${previousBlockHeight}`);
        const previousBlockHash = await previousBlockHashResponse.text();
        const previousBlockTransactionsResponse = await fetch(`https://mempool.space/api/block/${previousBlockHash}`);
        const previousBlockData = await previousBlockTransactionsResponse.json();

        const blockDataHTML = `
          <div class="block-info">
            <h3>Previous Block (Height: ${previousBlockHeight})</h3>
            <p>Total Transactions: ${previousBlockData.tx_count}</p>
          </div>
        `;

        byId('blockData').innerHTML = blockDataHTML;
      } catch (error) {
        console.error('Error fetching previous block data:', error);
        byId('blockData').innerHTML = '<p>Failed to load previous block data. Please try again later.</p>';
      }
    }

    async function fetchNextBlock() {
      try {
        const currentBlockHeightResponse = await fetch('https://mempool.space/api/blocks/tip/height');
        const currentBlockHeight = await currentBlockHeightResponse.text();
        const nextBlockHeight = parseInt(currentBlockHeight) + 1;
        const nextBlockHashResponse = await fetch(`https://mempool.space/api/block-height/${nextBlockHeight}`);
        const nextBlockHash = await nextBlockHashResponse.text();
        const nextBlockTransactionsResponse = await fetch(`https://mempool.space/api/block/${nextBlockHash}`);
        const nextBlockData = await nextBlockTransactionsResponse.json();

        const blockDataHTML = `
          <div class="block-info">
            <h3>Next Block (Height: ${nextBlockHeight})</h3>
            <p>Total Transactions: ${nextBlockData.tx_count}</p>
          </div>
        `;

        byId('blockData').innerHTML = blockDataHTML;
      } catch (error) {
        console.error('Error fetching next block data:', error);
        byId('blockData').innerHTML = '<p>Next block not yet mined or failed to load. Please try again later.</p>';
      }
    }

    /* --- Farcaster Integration --- */
    async function connectWallet() {
      try {
        // Initialize the SDK
        const { sdk: farcasterSdk } = await import('https://esm.sh/@farcaster/miniapp-sdk');
        sdk = farcasterSdk;

        // Request the user to sign in
        const { fid, name } = await sdk.actions.signIn();
        myFid = fid;
        myName = name;

        // Update the status message
        byId('status').textContent = `Connected to Farcaster as ${name} (${fid})`;

        // Add a message to the chat indicating the wallet connection
        addChatMessage('System', `${name} (${fid}) has joined the battle!`);
      } catch (error) {
        console.error('Error connecting to Farcaster wallet:', error);
        alert('Failed to connect to Farcaster wallet. Please try again.');
      }
    }

    /* --- SDK Integration and Initialization --- */
    async function initializeMiniApp() {
      try {
        console.log('Initializing Farcaster MiniApp SDK...');

        // Attempt automatic login
        try {
          const user = await sdk.user.get();
          if (user) {
            myFid = user.fid;
            myName = user.name;
            byId('status').textContent = `Connected to Farcaster as ${user.name} (${user.fid})`;
          }
        } catch (error) {
          console.log('No existing session. Showing connect wallet button.');
          document.getElementById('connectWalletBtn').style.display = 'block';
        }

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
          await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));
        }

        console.log('DOM ready, calling sdk.actions.ready()...');

        // This is the CRITICAL call that fixes "Ready not called" error
        await sdk.actions.ready();

        console.log('MiniApp is ready!');

        // Hide loading screen and show content
        showContent();

        // Set up event listeners
        setupEventListeners();

      } catch (error) {
        console.error('Failed to initialize MiniApp:', error);
        showError();
      }
    }

    function showContent() {
      const loadingScreen = document.getElementById('loadingScreen');
      const mainContainer = document.querySelector('.container');

      // Hide loading screen
      loadingScreen.classList.add('hidden');

      // Show main content with animation
      setTimeout(() => {
        mainContainer.style.opacity = '1';
        mainContainer.style.transform = 'translateY(0)';
      }, 100);
    }

    function showError() {
      const loadingScreen = document.getElementById('loadingScreen');
      const mainContainer = document.querySelector('.container');
      const errorMessage = document.createElement('div');
      errorMessage.style.background = 'rgba(255, 0, 0, 0.1)';
      errorMessage.style.border = '1px solid rgba(255, 0, 0, 0.3)';
      errorMessage.style.color = 'white';
      errorMessage.style.padding = '15px';
      errorMessage.style.borderRadius = '10px';
      errorMessage.style.marginBottom = '20px';
      errorMessage.textContent = '⚠️ Failed to initialize MiniApp SDK. Please refresh the page.';

      loadingScreen.classList.add('hidden');
      mainContainer.insertBefore(errorMessage, mainContainer.firstChild);
    }

    function setupEventListeners() {
      // Existing event listeners
      document.getElementById('lockBtn').onclick = lockGuess;
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
    }

    /* --- INITIAL RENDER --- */
    // Start initialization
    initializeMiniApp();

    // Fallback timeout
    setTimeout(() => {
      const loadingScreen = document.getElementById('loadingScreen');
      if (!loadingScreen.classList.contains('hidden')) {
        console.warn('SDK initialization timeout, showing content anyway');
        showContent();
      }
    }, 10000); // 10 second timeout
  </script>
</body>
</html>
