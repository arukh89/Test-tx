<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TX Battle Royale</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="/icons/icon-192.png">
  <meta property="og:title" content="TX Battle Royale">
  <meta property="og:description" content="BTC Block Prediction Game">
  <meta property="og:image" content="https://25b09b7b-8fbd-46f6-a599-1a3a8bdad572-00-110pjaimlcgd1.worf.replit.dev/og.png">
  <meta property="og:url" content="https://25b09b7b-8fbd-46f6-a599-1a3a8bdad572-00-110pjaimlcgd1.worf.replit.dev">

  <!-- Farcaster Mini App embed -->
  <meta name="fc:miniapp" content='{
    "version": "1",
    "imageUrl": "https://25b09b7b-8fbd-46f6-a599-1a3a8bdad572-00-110pjaimlcgd1.worf.replit.dev/og.png",
    "button": {
      "title": "Open App",
      "action": {
        "type": "launch_frame",
        "name": "TX Battle Royale",
        "url": "https://25b09b7b-8fbd-46f6-a599-1a3a8bdad572-00-110pjaimlcgd1.worf.replit.dev",
        "splashImageUrl": "https://25b09b7b-8fbd-46f6-a599-1a3a8bdad572-00-110pjaimlcgd1.worf.replit.dev/og.png",
        "splashBackgroundColor": "#1a1a1a"
      }
    }
  }'>
</head>
<body>
  <div class="container">
    <header>
      <h1>TX Battle Royale</h1>
      <p class="subtitle">BTC Block Prediction</p>
    </header>

    <p class="status" id="status">Connecting...</p>

    <div class="grid">
      <!-- Battle Arena -->
      <div class="card">
        <h2>Battle Arena</h2>
        <div class="row">
          <button class="cta" id="joinBtn">Join Battle</button>
          <button class="cta" id="shareBtn">Share</button>
          <button class="cta" id="prevBlockBtn">Previous Block</button>
          <button class="cta" id="currBlockBtn">Present Block</button>
        </div>

        <p class="small muted">Your TX guess</p>
        <div class="row">
          <input type="number" id="predictionInput" placeholder="e.g. 2500">
          <button class="cta" id="submitPrediction">Submit Prediction</button>
        </div>

        <p class="small">Players (<span id="playerCount">0</span>)</p>
        <ul id="playerList"></ul>

        <h3>Chat</h3>
        <div class="chatBox" id="chatBox"></div>
        <div class="row">
          <input type="text" id="chatInput" placeholder="Say something...">
          <button class="cta" id="sendBtn">Send</button>
        </div>
      </div>

      <!-- Leaderboard -->
      <div class="card leaderboard">
        <h2>Leaderboard</h2>
        
        <!-- Farcaster Wallet Connection -->
        <div class="wallet-section">
          <h3>üé≠ Farcaster Wallet</h3>
          <p class="small" id="userStatus">Not connected</p>
          <button class="cta wallet-btn" id="connectWalletBtn">Connect Farcaster Wallet</button>
          <button class="cta wallet-btn disconnect hidden" id="disconnectWalletBtn">Disconnect</button>
        </div>
        
        <ul id="leaderboardList"></ul>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Enhanced Farcaster SDK initialization with immediate ready signal
    function initializeFarcasterSDK() {
      console.log("üé≠ Initializing Farcaster Mini App SDK...");
      
      try {
        if (typeof MiniAppSDK !== 'undefined') {
          window.miniApp = MiniAppSDK;
          console.log("‚úÖ Farcaster SDK loaded successfully");
          
          // Immediately signal app is ready
          if (MiniAppSDK.actions && typeof MiniAppSDK.actions.ready === 'function') {
            console.log("üöÄ Calling ready() immediately...");
            MiniAppSDK.actions.ready();
            console.log("‚úÖ Ready signal sent to Farcaster");
          } else {
            console.log("‚ö†Ô∏è MiniAppSDK.actions.ready not available");
          }
          
          // Test SDK availability
          console.log("üìã Available SDK actions:", Object.keys(MiniAppSDK.actions || {}));
          
          return true;
        } else {
          console.log("‚ö†Ô∏è MiniAppSDK not available, signaling ready via postMessage");
          // Fallback ready signal via postMessage
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'ready' }, '*');
            console.log("üì§ Sent ready signal via postMessage");
          }
          return false;
        }
      } catch (error) {
        console.error("‚ùå Error initializing Farcaster SDK:", error);
        // Send ready signal anyway as fallback
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'ready' }, '*');
        }
        return false;
      }
    }
    
    // Immediate ready signal as soon as possible
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({ type: 'ready' }, '*');
    }
  </script>
  <script src="https://unpkg.com/@farcaster/miniapp-sdk@latest/dist/index.umd.js" onload="initializeFarcasterSDK()" onerror="initializeFarcasterSDK()"></script>
  <script>
    // Backup initialization attempts
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(function() {
        if (typeof window.miniApp === 'undefined') {
          initializeFarcasterSDK();
        }
      }, 100);
    });
    
    window.addEventListener('load', function() {
      setTimeout(function() {
        if (typeof window.miniApp === 'undefined') {
          initializeFarcasterSDK();
        }
      }, 200);
    });
  </script>
  <script src="app.js"></script>
</body>
</html>